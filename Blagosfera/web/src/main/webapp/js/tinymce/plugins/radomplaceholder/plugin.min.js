tinymce.PluginManager.add("radomplaceholder", function(editor) {
	
	var placeholdersMap = {};
	placeholdersMap["{{sharer.fullName}}"] = "Фамилия Имя Отчество участника";
	placeholdersMap["{{sharer.shortName}}"] = "Фамилия И. О. участника";
	
	placeholdersMap["{{sharer.birthday}}"] = "Дата рождения участника";
	
	placeholdersMap["{{sharer.inn}}"] = "ИНН участника";
	
	placeholdersMap["{{sharer.passportSeries}}"] = "Серия паспорта участника";
	placeholdersMap["{{sharer.passportNumber}}"] = "Номер паспорта участника";
	placeholdersMap["{{sharer.passpostDate}}"] = "Дата выдачи паспорта участника";
	placeholdersMap["{{sharer.passportDealer}}"] = "Кем выдан паспорт участника";
	placeholdersMap["{{sharer.passportDivision}}"] = "Код подразделения, выдавшего паспорт участника";
	
	placeholdersMap["{{sharer.homePhone}}"] = "Домашний телефон участника";
	placeholdersMap["{{sharer.mobilePhone}}"] = "Мобильный телефон участника";
	placeholdersMap["{{sharer.skype}}"] = "Скайп участника";
	placeholdersMap["{{sharer.website}}"] = "Вебсайт участника";
	
	placeholdersMap["{{sharer.registrationAddress.fullAddress}}"] = "Адрес регистрации участника";
	placeholdersMap["{{sharer.actualAddress.fullAddress}}"] = "Фактический адрес участника";
	
	placeholdersMap["{{registrator.fullName}}"] = "Фамилия Имя Отчество регистратора";
	placeholdersMap["{{registrator.shortName}}"] = "Фамилия И. О. регистратора";
	
	placeholdersMap["{{registrator.birthday}}"] = "Дата рождения регистратора";
	
	placeholdersMap["{{registrator.inn}}"] = "ИНН регистратора";
	
	placeholdersMap["{{registrator.passportSeries}}"] = "Серия паспорта регистратора";
	placeholdersMap["{{registrator.passportNumber}}"] = "Номер паспорта регистратора";
	placeholdersMap["{{registrator.passpostDate}}"] = "Дата выдачи паспорта регистратора";
	placeholdersMap["{{registrator.passportDealer}}"] = "Кем выдан паспорт регистратора";
	placeholdersMap["{{registrator.passportDivision}}"] = "Код подразделения, выдавшего паспорт регистратора";
	
	placeholdersMap["{{registrator.homePhone}}"] = "Домашний телефон регистратора";
	placeholdersMap["{{registrator.mobilePhone}}"] = "Мобильный телефон регистратора";
	placeholdersMap["{{registrator.skype}}"] = "Скайп регистратора";
	placeholdersMap["{{registrator.website}}"] = "Вебсайт регистратора";
	
	placeholdersMap["{{registrator.registrationAddress}}"] = "Адрес регистрации регистратора";
	placeholdersMap["{{registrator.actualAddress}}"] = "Фактический адрес регистратора";
	placeholdersMap["{{registrator.registratorOfficeAddress}}"] = "Адрес офиса регистратора";
	
	placeholdersMap["#DOCUMENT_NUMBER"] = "Номер документа";
	placeholdersMap["#DOCUMENT_DATE"] = "Дата документа";
	
	function getPlaceholderByLabel(label) {
		for (var placeholder in placeholdersMap) {
			if (placeholdersMap[placeholder] === label) {
				return placeholder;
			}
		}
	}
	
	function getMenu() {
		var menu = [];
		for (var placeholder in placeholdersMap) {
			menu.push({
				text: placeholdersMap[placeholder],
				value : placeholder,
				onclick: function() {
					insertPlaceholder(this.value());
				}				
			});
		}
		return menu;
	}
	
	function getPlaceholderMarkup(placeholder) {
		var label = placeholdersMap[placeholder];
		var markup =  "<span style='border : 1px solid;' data-placeholder class='mceNonEditable'>" + label + "</span>";
		return markup;
	}
	
	function insertPlaceholder(placeholder) {
		editor.execCommand("mceInsertContent", !1, getPlaceholderMarkup(placeholder));
	}
	
	editor.addButton('radomplaceholder', {
        type: 'menubutton',
        text: false,
        icon: false,
        image : "/i/logo.png",
        tooltip : "Блоки автоподстановки",
        menu: getMenu()
    });
	
	editor.on('PostProcess', function(e) {
		console.log(e.content);
		var $content = $(e.content);
		$.each($content.find("span[data-placeholder]"), function(index, span) {
			var $span = $(span);
			var label = $span.html();
			var placeholder = getPlaceholderByLabel(label);
			console.log($span + " --> " + placeholder);
			$span.replaceWith(placeholder);
		});

		var $tempDiv = $("<div></div>");
		$tempDiv.append($content);
		var content = $tempDiv.html();
		
		e.content = content;
	});
	
	editor.on('BeforeSetContent', function(e) {
        var content = e.content;
        for (var placeholder in placeholdersMap) {
        	var regex = new RegExp(placeholder, "ig");
        	content = content.replace(regex, getPlaceholderMarkup(placeholder));
        }
        e.content = content;
    });
	
});